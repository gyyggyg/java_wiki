[
    {
        "type": "section",
        "id": "5.",
        "title": "调用链关键类之间关系说明",
        "content": [
          {
            "type": "uml",
            "meta": "mermaid",
            "content": [
          "classDiagram\n    direction TB\n\n    %% ==============================\n    %% Controller层\n    %% ==============================\n    class AlipayController {\n        - AlipayConfig alipayConfig\n        - AlipayService alipayService\n        +pay(AliPayParam, HttpServletResponse)\n        +webPay(AliPayParam, HttpServletResponse)\n        +notify(HttpServletRequest) String\n        +query(String, String) CommonResult~String~\n    }\n\n    %% ==============================\n    %% 支付宝相关\n    %% ==============================\n    class AlipayService {\n        <<interface>>\n        +pay(AliPayParam) String\n        +notify(Map~String, String~) String\n        +query(String, String) String\n        +webPay(AliPayParam) String\n    }\n    class AlipayServiceImpl {\n        +pay(AliPayParam) String\n        +notify(Map~String, String~) String\n        +query(String, String) String\n        +webPay(AliPayParam) String\n    }\n\n    %% ==============================\n    %% 通用返回类型\n    %% ==============================\n    class CommonResult~T~ {\n        -long code\n        -String message\n        -T data\n        +success(T data) CommonResult~T~\n        +success(T data, String message) CommonResult~T~\n        +failed(IErrorCode errorCode) CommonResult~T~\n        +failed(IErrorCode errorCode, String message) CommonResult~T~\n        +failed(String message) CommonResult~T~\n        +failed() CommonResult~T~\n        +validateFailed() CommonResult~T~\n        +validateFailed(String message) CommonResult~T~\n        +unauthorized(T data) CommonResult~T~\n        +forbidden(T data) CommonResult~T~\n        +getCode() long\n        +getMessage() String\n        +getData() T\n    }\n\n    %% ==============================\n    %% 订单相关 Service\n    %% ==============================\n    class OmsPortalOrderService {\n        <<interface>>\n        +generateConfirmOrder(List~Long~) ConfirmOrderResult\n        +generateOrder(OrderParam) Map~String, Object~\n        +paySuccess(Long, Integer) Integer\n        +cancelTimeOutOrder() Integer\n        +cancelOrder(Long)\n        +sendDelayMessageCancelOrder(Long)\n        +confirmReceiveOrder(Long)\n        +list(Integer, Integer, Integer) CommonPage~OmsOrderDetail~\n        +detail(Long) OmsOrderDetail\n        +deleteOrder(Long)\n        +paySuccessByOrderSn(String, Integer)\n    }\n    class OmsPortalOrderServiceImpl {\n        +generateConfirmOrder(List~Long~) ConfirmOrderResult\n        +generateOrder(OrderParam) Map~String, Object~\n        +paySuccess(Long, Integer) Integer\n        +cancelTimeOutOrder() Integer\n        +cancelOrder(Long)\n        +sendDelayMessageCancelOrder(Long)\n        +confirmReceiveOrder(Long)\n        +list(Integer, Integer, Integer) CommonPage~OmsOrderDetail~\n        +detail(Long) OmsOrderDetail\n        +deleteOrder(Long)\n        +paySuccessByOrderSn(String, Integer)\n        ..内部方法..\n        -generateOrderSn(OmsOrder) String\n        -deleteCartItemList(List, UmsMember)\n        -updateCouponStatus(Long, Long, Integer)\n        -calcCartAmount(List) ConfirmOrderResult.CalcAmount\n    }\n\n    %% ==============================\n    %% 订单实体及持久层\n    %% ==============================\n    class OmsOrder {\n        -Long id\n        -Long memberId\n        -Long couponId\n        -String orderSn\n        -Date createTime\n        -String memberUsername\n        -BigDecimal totalAmount\n        -BigDecimal payAmount\n        -BigDecimal freightAmount\n        -BigDecimal promotionAmount\n        -BigDecimal integrationAmount\n        -BigDecimal couponAmount\n        -BigDecimal discountAmount\n        -Integer payType\n        -Integer sourceType\n        -Integer status\n        -Integer orderType\n        -String deliveryCompany\n        -String deliverySn\n        -Integer autoConfirmDay\n        -Integer integration\n        -Integer growth\n        -String promotionInfo\n        -Integer billType\n        -String billHeader\n        -String billContent\n        -String billReceiverPhone\n        -String billReceiverEmail\n        -String receiverName\n        -String receiverPhone\n        -String receiverPostCode\n        -String receiverProvince\n        -String receiverCity\n        -String receiverRegion\n        -String receiverDetailAddress\n        -String note\n        -Integer confirmStatus\n        -Integer deleteStatus\n        -Integer useIntegration\n        -Date paymentTime\n        -Date deliveryTime\n        -Date receiveTime\n        -Date commentTime\n        -Date modifyTime\n        +getId() Long\n        +getStatus() Integer\n        +setDeleteStatus(Integer)\n        +...（其余get/set省略）\n    }\n\n    class OmsOrderMapper {\n        <<interface>>\n        +selectByPrimaryKey(Long) OmsOrder\n        +selectByExample(OmsOrderExample) List~OmsOrder~\n        +insert(OmsOrder)\n        +updateByPrimaryKey(OmsOrder)\n        +updateByExampleSelective(OmsOrder, OmsOrderExample)\n    }\n\n    class OmsOrderExample {\n        +createCriteria() Criteria\n        +setOrderByClause(String)\n    }\n    class OmsOrderItem {\n        -Long id\n        -Long orderId\n        -String orderSn\n        -Long productId\n        -BigDecimal productPrice\n        -Integer productQuantity\n        -Long productSkuId\n        -String productSkuCode\n        -Long productCategoryId\n        -String promotionName\n        -BigDecimal promotionAmount\n        -BigDecimal couponAmount\n        -BigDecimal integrationAmount\n        -BigDecimal realAmount\n        -Integer giftIntegration\n        -Integer giftGrowth\n        -String productAttr\n        +getProductId() Long\n        +getProductPrice() BigDecimal\n        +getProductQuantity() Integer\n        +getPromotionAmount() BigDecimal\n        +getCouponAmount() BigDecimal\n        +setRealAmount(BigDecimal)\n        +setCouponAmount(BigDecimal)\n        +setOrderId(Long)\n        +setOrderSn(String)\n        +...（其余get/set省略）\n    }\n    class OmsOrderItemExample {\n        +createCriteria() Criteria\n    }\n    class OmsOrderSetting {\n        -Long id\n        -Integer flashOrderOvertime\n        -Integer normalOrderOvertime\n        -Integer confirmOvertime\n        -Integer finishOvertime\n        -Integer commentOvertime\n        +getNormalOrderOvertime() Integer\n        +getConfirmOvertime() Integer\n    }\n    class OmsOrderSettingMapper {\n        <<interface>>\n        +selectByPrimaryKey(Long) OmsOrderSetting\n        +selectByExample(OmsOrderSettingExample) List~OmsOrderSetting~\n    }\n\n    %% ==============================\n    %% 购物车相关\n    %% ==============================\n    class OmsCartItem {\n        -Long id\n        -Long productId\n        -Long productSkuId\n        -Integer quantity\n        -BigDecimal price\n        -String productPic\n        -String productName\n        -String productSkuCode\n        -Long productCategoryId\n        -String productBrand\n        -String productSn\n        -String productAttr\n        +getQuantity() Integer\n        +getPrice() BigDecimal\n        +getProductId() Long\n        +getProductSkuId() Long\n        +getProductSkuCode() String\n        +getProductCategoryId() Long\n        +getProductBrand() String\n        +getProductPic() String\n        +getProductName() String\n        +getProductSn() String\n        +getProductAttr() String\n    }\n    class OmsCartItemService {\n        <<interface>>\n        +listPromotion(Long, List~Long~) List~CartPromotionItem~\n        +delete(Long, List~Long~)\n    }\n\n    %% ==============================\n    %% 会员、地址、积分相关\n    %% ==============================\n    class UmsMember {\n        -Long id\n        -String username\n        -Integer integration\n        +getId() Long\n        +getIntegration() Integer\n        +setIntegration(Integer)\n        +getUsername() String\n    }\n    class UmsMemberService {\n        <<interface>>\n        +getCurrentMember() UmsMember\n        +getById(Long) UmsMember\n        +updateIntegration(Long, Integer)\n    }\n    class UmsMemberReceiveAddress {\n        -Long id\n        -String name\n        -String phoneNumber\n        -String postCode\n        -String province\n        -String city\n        -String region\n        -String detailAddress\n        +getName() String\n        +getPhoneNumber() String\n        +getPostCode() String\n        +getProvince() String\n        +getCity() String\n        +getRegion() String\n        +getDetailAddress() String\n    }\n    class UmsMemberReceiveAddressService {\n        <<interface>>\n        +list() List~UmsMemberReceiveAddress~\n        +getItem(Long) UmsMemberReceiveAddress\n    }\n    class UmsIntegrationConsumeSetting {\n        -Long id\n        -Integer deductionPerAmount\n        -Integer maxPercentPerOrder\n        -Integer useUnit\n        -Integer couponStatus\n        +getUseUnit() Integer\n        +getCouponStatus() Integer\n        +getMaxPercentPerOrder() Integer\n    }\n    class UmsIntegrationConsumeSettingMapper {\n        <<interface>>\n        +selectByPrimaryKey(Long) UmsIntegrationConsumeSetting\n    }\n\n    %% ==============================\n    %% 优惠券相关\n    %% ==============================\n    class UmsMemberCouponService {\n        <<interface>>\n        +listCart(List~CartPromotionItem~, Integer) List~SmsCouponHistoryDetail~\n    }\n    class SmsCoupon {\n        -Long id\n        -BigDecimal amount\n        -Integer useType\n        +getId() Long\n        +getAmount() BigDecimal\n        +getUseType() Integer\n    }\n    class SmsCouponHistoryDetail {\n        -SmsCoupon coupon\n        -List~SmsCouponProductCategoryRelation~ categoryRelationList\n        -List~SmsCouponProductRelation~ productRelationList\n        +getCoupon() SmsCoupon\n        +getCategoryRelationList() List~SmsCouponProductCategoryRelation~\n        +getProductRelationList() List~SmsCouponProductRelation~\n    }\n    class SmsCouponHistoryExample {\n        +createCriteria() Criteria\n    }\n    class SmsCouponHistory {\n        -Long id\n        -Long couponId\n        -Long memberId\n        -Integer useStatus\n        -Date useTime\n        +setUseStatus(Integer)\n        +setUseTime(Date)\n    }\n    class SmsCouponHistoryMapper {\n        <<interface>>\n        +selectByExample(SmsCouponHistoryExample) List~SmsCouponHistory~\n        +updateByPrimaryKeySelective(SmsCouponHistory)\n    }\n    class SmsCouponProductRelation {\n        -Long productId\n        +getProductId() Long\n    }\n    class SmsCouponProductCategoryRelation {\n        -Long productCategoryId\n        +getProductCategoryId() Long\n    }\n\n    %% ==============================\n    %% DAO和分页\n    %% ==============================\n    class PortalOrderDao {\n        <<interface>>\n        +getDetail(Long) OmsOrderDetail\n        +getTimeOutOrders(Integer) List~OmsOrderDetail~\n        +updateOrderStatus(List~Long~, Integer)\n        +releaseSkuStockLock(List~OmsOrderItem~)\n        +lockStockBySkuId(Long, Integer)\n        +reduceSkuStock(Long, Integer)\n        +releaseStockBySkuId(Long, Integer)\n    }\n    class PortalOrderItemDao {\n        <<interface>>\n        +insertList(List~OmsOrderItem~)\n    }\n    class CommonPage~T~ {\n        -Integer pageNum\n        -Integer pageSize\n        -Integer totalPage\n        -Long total\n        -List~T~ list\n        +restPage(List~T~) CommonPage~T~\n        +getPageNum() Integer\n        +setPageNum(Integer)\n        +setPageSize(Integer)\n        +getTotal() Long\n        +setTotal(Long)\n        +setList(List~T~)\n        +setTotalPage(Integer)\n        +getTotalPage() Integer\n    }\n\n    %% ==============================\n    %% 其它\n    %% ==============================\n    class Asserts {\n        +fail(String)\n        +fail(IErrorCode)\n    }\n    class RedisService {\n        <<interface>>\n        +incr(String, long) Long\n    }\n    class CancelOrderSender {\n        +sendMessage(Long, long)\n    }\n    class PmsSkuStock {\n        -Integer lockStock\n        +setLockStock(Integer)\n        +getLockStock() Integer\n    }\n    class CartPromotionItem {\n        -Long id\n        -Long productId\n        -Long productSkuId\n        -Integer quantity\n        -BigDecimal price\n        -BigDecimal reduceAmount\n        -Integer integration\n        -Integer growth\n        -String productName\n        -String productBrand\n        -String productPic\n        -String productSkuCode\n        -Long productCategoryId\n        -String promotionMessage\n        -Integer realStock\n        +getId() Long\n        +getProductId() Long\n        +getProductSkuId() Long\n        +getQuantity() Integer\n        +getPrice() BigDecimal\n        +getReduceAmount() BigDecimal\n        +getIntegration() Integer\n        +getGrowth() Integer\n        +getProductName() String\n        +getProductBrand() String\n        +getProductPic() String\n        +getProductSkuCode() String\n        +getProductCategoryId() Long\n        +getPromotionMessage() String\n        +getRealStock() Integer\n    }\n    class OmsOrderDetail {\n        -Long id\n        -List~OmsOrderItem~ orderItemList\n        +getId() Long\n        +getOrderItemList() List~OmsOrderItem~\n        +setOrderItemList(List~OmsOrderItem~)\n    }\n    class ConfirmOrderResult {\n        -List~CartPromotionItem~ cartPromotionItemList\n        -List~UmsMemberReceiveAddress~ memberReceiveAddressList\n        -List~SmsCouponHistoryDetail~ couponHistoryDetailList\n        -Integer memberIntegration\n        -UmsIntegrationConsumeSetting integrationConsumeSetting\n        -CalcAmount calcAmount\n        +setCartPromotionItemList(List~CartPromotionItem~)\n        +setMemberReceiveAddressList(List~UmsMemberReceiveAddress~)\n        +setCouponHistoryDetailList(List~SmsCouponHistoryDetail~)\n        +setMemberIntegration(Integer)\n        +setIntegrationConsumeSetting(UmsIntegrationConsumeSetting)\n        +setCalcAmount(CalcAmount)\n    }\n    class CalcAmount {\n        -BigDecimal totalAmount\n        -BigDecimal promotionAmount\n        -BigDecimal payAmount\n        -BigDecimal freightAmount\n        +setTotalAmount(BigDecimal)\n        +setPromotionAmount(BigDecimal)\n        +setPayAmount(BigDecimal)\n        +setFreightAmount(BigDecimal)\n    }\n\n    %% ==============================\n    %% 关系\n    %% ==============================\n\n    %% 控制器与服务\n    AlipayController --> AlipayService : 使用\n    AlipayController --> CommonResult : 使用(success)\n\n    %% 支付实现\n    AlipayServiceImpl ..|> AlipayService : 实现\n    AlipayServiceImpl --> OmsPortalOrderService : 使用\n    AlipayServiceImpl --> PortalOrderDao : 使用\n\n    %% 订单服务实现\n    OmsPortalOrderServiceImpl ..|> OmsPortalOrderService : 实现\n    OmsPortalOrderServiceImpl --> OmsOrderMapper : 使用\n    OmsPortalOrderServiceImpl --> OmsOrder : 使用/返回\n    OmsPortalOrderServiceImpl --> OmsOrderExample : 使用\n    OmsPortalOrderServiceImpl --> OmsOrderSetting : 使用\n    OmsPortalOrderServiceImpl --> OmsOrderSettingMapper : 使用\n    OmsPortalOrderServiceImpl --> OmsOrderItem : 使用\n    OmsPortalOrderServiceImpl --> OmsOrderItemExample : 使用\n    OmsPortalOrderServiceImpl --> PortalOrderDao : 使用\n    OmsPortalOrderServiceImpl --> PortalOrderItemDao : 使用\n    OmsPortalOrderServiceImpl --> OmsCartItemService : 使用\n    OmsPortalOrderServiceImpl --> UmsMemberService : 使用\n    OmsPortalOrderServiceImpl --> UmsMember : 使用\n    OmsPortalOrderServiceImpl --> UmsMemberReceiveAddressService : 使用\n    OmsPortalOrderServiceImpl --> UmsMemberReceiveAddress : 使用\n    OmsPortalOrderServiceImpl --> UmsIntegrationConsumeSettingMapper : 使用\n    OmsPortalOrderServiceImpl --> UmsIntegrationConsumeSetting : 使用\n    OmsPortalOrderServiceImpl --> UmsMemberCouponService : 使用\n    OmsPortalOrderServiceImpl --> SmsCouponHistoryExample : 使用\n    OmsPortalOrderServiceImpl --> SmsCouponHistory : 使用\n    OmsPortalOrderServiceImpl --> SmsCouponHistoryMapper : 使用\n    OmsPortalOrderServiceImpl --> SmsCouponProductCategoryRelation : 使用\n    OmsPortalOrderServiceImpl --> SmsCouponProductRelation : 使用\n    OmsPortalOrderServiceImpl --> SmsCoupon : 使用\n    OmsPortalOrderServiceImpl --> CommonPage : 返回\n    OmsPortalOrderServiceImpl --> ConfirmOrderResult : 返回\n    OmsPortalOrderServiceImpl --> OmsOrderDetail : 返回\n    OmsPortalOrderServiceImpl --> Asserts : 使用\n    OmsPortalOrderServiceImpl --> RedisService : 使用\n    OmsPortalOrderServiceImpl --> CancelOrderSender : 使用\n    OmsPortalOrderServiceImpl --> PmsSkuStockMapper : 使用\n    OmsPortalOrderServiceImpl --> PmsSkuStock : 使用\n    OmsPortalOrderServiceImpl --> CartPromotionItem : 使用\n    OmsPortalOrderServiceImpl --> CalcAmount : 使用\n\n    %% Mapper间\n    OmsOrderMapper --> OmsOrder : 返回\n    OmsOrderSettingMapper --> OmsOrderSetting : 返回\n    SmsCouponHistoryMapper --> SmsCouponHistory : 返回\n\n    %% 其它\n    UmsMemberService --> UmsMember : 返回\n    UmsMemberReceiveAddressService --> UmsMemberReceiveAddress : 返回\n    UmsIntegrationConsumeSettingMapper --> UmsIntegrationConsumeSetting : 返回\n    UmsMemberCouponService --> SmsCouponHistoryDetail : 返回\n    SmsCouponHistoryDetail --> SmsCoupon : getCoupon()\n    SmsCouponHistoryDetail --> SmsCouponProductCategoryRelation : getCategoryRelationList()\n    SmsCouponHistoryDetail --> SmsCouponProductRelation : getProductRelationList()\n    PortalOrderDao --> OmsOrderDetail : getDetail()\n    PortalOrderDao --> OmsOrderItem : 使用\n    PortalOrderItemDao --> OmsOrderItem : insertList\n    CartPromotionItem --> OmsCartItem : 组合\n\n    %% 泛型依赖\n    CommonPage o-- OmsOrderDetail\n    CommonPage o-- OmsOrder\n\n    ConfirmOrderResult o-- CalcAmount\n    ConfirmOrderResult o-- CartPromotionItem\n    ConfirmOrderResult o-- UmsMemberReceiveAddress\n    ConfirmOrderResult o-- SmsCouponHistoryDetail\n\n    OmsOrderDetail o-- OmsOrderItem\n\n    OmsPortalOrderServiceImpl ..> CommonResult : 返回类型\n    AlipayController ..> CommonResult : 返回类型\n\n    %% 泛型标注\n    class CommonResult~T~ {\n        <<generic>>\n    }\n    class CommonPage~T~ {\n        <<generic>>\n    }"
            ],
            "source_id":["384", "518", "519", "525", "533", "280", "281", "540", "286", "414", "416", "545", "418", "419", "420", "549", "421", "551", "556", "557", "558", "559", "306", "307", "566", "454", "456", "330", "465", "248", "365", "238", "239", "495", "245", "374", "504", "377", "381", "382", "383"]
          },
          {
            "type": "text",
            "meta": "markdown",
            "content": [
              "**说明：**\n\n- 箭头 `-->` 表示“使用/依赖/返回”关系，`..|>` 表示实现接口，`o--` 表示聚合/组合关系\n- `<<interface>>`、`<<generic>>` 及其他标注用于区分接口、泛型等\n- 关键方法与属性已在节点中简要列出，实际类成员较多时已省略部分 getter/setter\n- 该UML图覆盖了支付宝支付、订单处理、优惠券等主要业务链路的结构与调用关系"
            ]
          }
        ]
      },
    {
        "type": "section",
        "id": "6.",
        "title": "数据结构说明",
        "content": [
            {
                "type": "section",
                "id": "6.1 ",
                "title": "OmsPortalOrderServiceImpl整体介绍",
                "content": [
                    {
                        "type": "text",
                        "meta": "markdown",
                        "content": ["**定位与职责：**\n\nOmsPortalOrderServiceImpl 是 mall 电商系统前台（portal）模块中订单处理的核心业务实现类，实现了 OmsPortalOrderService 接口。\n它主要负责订单的整个生命周期管理，包括订单确认、创建、支付回调、超时与手动取消、收货确认、订单查询与逻辑删除等。\n该类通过整合会员、购物车、优惠券、库存、订单数据表与消息队列等多个外部组件，实现订单业务流程的自动化与高并发下的业务一致性，解决了电商前台订单处理的复杂业务需求。"],
                        "source_id":["566"]
                    },
                    {
                        "type": "text",
                        "meta": "markdown",
                        "content": ["**主要解决问题：**\n\n- 支持高并发下唯一订单号生成与订单落库\n- 订单创建时库存锁定与扣减，避免超卖\n- 多种优惠（促销/优惠券/积分）金额分摊与计算\n- 订单超时自动取消、手动取消的可靠实现（延迟消息+定时任务）\n- 订单状态流转（未支付→已支付→发货→收货→完成/关闭）\n- 订单数据的分页查询、详情获取和逻辑删除"],
                        "source_id":["566"]
                    }
                ]
            },
            {
                "type": "section",
                "id": "6.2 ",
                "title": "关键函数paySuccess控制流",
                "content": [
                    {
                        "type": "chart",
                        "meta": "mermaid",
                        "content": ["flowchart TD\n    direction TB\n    %% ---- Initialization ----\n    subgraph Initialization\n        A1[\"准备订单支付信息\n(设置订单号、状态=已支付、支付时间、支付方式)\n[2-7]\"]\n        style A1 fill:#0af,stroke:#036,stroke-width:4px\n\n        A2[\"构建未支付订单的筛选条件\n(订单ID/未删除/未支付)\n[8-12]\"]\n        style A2 fill:#0af,stroke:#036,stroke-width:4px\n\n        A3[\"更新订单为已支付状态\n[13]\"]\n        style A3 fill:#0af,stroke:#036,stroke-width:4px\n    end\n\n    %% ---- Order Update Decision ----\n    B1[\"订单状态允许更新?\n(updateCount==0)\n[14]\"]\n    style B1 fill:#fff,stroke:#333,stroke-width:2px,shape:diamond\n\n    B2[\"订单不存在或已支付\n(中断并返回错误)\n[15]\"]\n    style B2 fill:#fbb,stroke:#f96,stroke-width:2px,stroke-dasharray:5 5\n\n    %% ---- Inventory Adjustment ----\n    subgraph InventoryAdjustment\n        C1[\"获取订单商品明细\n[17]\"]\n        style C1 fill:#0af,stroke:#036,stroke-width:4px\n\n        C2[\"遍历订单商品，扣减实际库存\n(包含恢复锁定库存)\n[19-23]\"]\n        style C2 fill:#0af,stroke:#036,stroke-width:4px\n\n        C3[\"当前商品库存充足?\n(count==0)\n[21]\"]\n        style C3 fill:#fff,stroke:#333,stroke-width:2px,shape:diamond\n\n        C4[\"库存不足，扣减失败\n(中断并返回错误)\n[22]\"]\n        style C4 fill:#fbb,stroke:#f96,stroke-width:2px,stroke-dasharray:5 5\n\n        C5[\"累计本次商品扣减数量\n[23]\"]\n        style C5 fill:#0af,stroke:#036,stroke-width:4px\n    end\n\n    %% ---- Return ----\n    D1[\"返回本次支付扣减的库存总数\n[25]\"]\n    style D1 fill:#0af,stroke:#036,stroke-width:4px\n\n    %% ---- Control Flow ----\n    A1 --> A2\n    A2 --> A3\n    A3 -- 主要路径 --> B1\n    B1 -- 否 --> B2\n    B1 -- 是 --> C1\n    B2 -. 错误终止 .-> D1\n    C1 --> C2\n    C2 --> C3\n    C3 -- 否 --> C4\n    C4 -. 错误终止 .-> D1\n    C3 -- 是 --> C5\n    C5 -- 循环至所有商品处理完毕 --> D1"],
                        "source_id":["566"]
                    }
                ]
            },
            {
                "type": "section",
                "id": "6.3 ",
                "title": "关键属性与配置信息",
                "content": [
                    {
                        "type": "text",
                        "meta": "markdown",
                        "content": ["| 字段/配置项 | 类型/来源 | 说明 |\n|------------------------------|---------------------------|---------------------------------------------------------------------------------------------|\n| `@Service` | Spring 注解 | 标记为 Spring 服务组件 |\n| `@Slf4j` | Lombok 注解 | 自动注入日志对象 log |\n| `memberService` | UmsMemberService | 会员相关操作（积分、信息、收货地址等） |\n| `cartItemService` | OmsCartItemService | 购物车业务（促销信息、购物车项管理） |\n| `memberReceiveAddressService` | UmsMemberReceiveAddressService | 会员收货地址管理 |\n| `memberCouponService` | UmsMemberCouponService | 会员优惠券服务（可用优惠券、优惠券状态修改） |\n| `integrationConsumeSettingMapper` | UmsIntegrationConsumeSettingMapper | 积分使用规则持久化接口 |\n| `skuStockMapper` | PmsSkuStockMapper | 商品 SKU 库存表操作 |\n| `couponHistoryDao` | SmsCouponHistoryDao | 优惠券历史 DAO |\n| `orderMapper` | OmsOrderMapper | 订单表持久化接口 |\n| `portalOrderDao` | PortalOrderDao | 订单详情、库存锁定/释放、订单状态批量更改等 |\n| `orderSettingMapper` | OmsOrderSettingMapper | 订单相关设置（超时、自动收货） |\n| `orderItemMapper` | OmsOrderItemMapper | 订单项持久化接口 |\n| `orderItemDao` | PortalOrderItemDao | 订单项批量插入 DAO |\n| `couponHistoryMapper` | SmsCouponHistoryMapper | 优惠券历史记录持久化接口 |\n| `redisService` | RedisService | Redis 操作接口，用于订单号自增 |\n| `cancelOrderSender` | CancelOrderSender | 消息队列发送组件，用于发送延迟取消订单消息 |\n| `REDIS_KEY_ORDER_ID` | 配置文件 `${redis.key.orderId}` | Redis 订单号自增键前缀 |\n| `REDIS_DATABASE` | 配置文件 `${redis.database}` | Redis 数据库标识 |\n| 订单状态枚举（硬编码 int） | 0-5 | 0:待付款, 1:待发货, 2:已发货, 3:已完成, 4:已关闭, 5:无效订单 |\n| 支付方式枚举（硬编码 int） | 0-2 | 0:未支付, 1:支付宝, 2:微信 |"],
                        "source_id":["566"]
                    },
                    {
                        "type": "section",
                        "id": "6.3.1 ",
                        "title": "依赖资源说明",
                        "content": [
                            {
                                "type": "text",
                                "meta": "markdown",
                                "content": ["- **数据库表**：订单（OmsOrder）、订单项（OmsOrderItem）、商品SKU（PmsSkuStock）、积分设置、优惠券历史等\n- **Redis**：用于订单号生成（日期+平台+支付+自增序列号，保证分布式唯一性）\n- **消息队列**：延迟队列（如RabbitMQ）异步取消超时订单\n- **外部服务/DAO**：会员、购物车、优惠券、库存相关接口"],
                                "source_id":["566"]
                            }
                        ]
                    }
                ]
            },
            {
                "type": "section",
                "id": "6.4 ",
                "title": "订单业务相关核心数据结构",
                "content": [
                    {
                        "type": "text",
                        "meta": "markdown",
                        "content": ["| 名称 | 说明 |\n|------------------------------|---------------------------------------------------------------------------------------------|\n| `OrderParam` | 用户提交订单时的参数，包括购物车ID列表、收货地址ID、优惠券ID、使用积分数、支付方式等 |\n| `ConfirmOrderResult` | 确认订单页面所需信息，含促销后的购物车项、收货地址、可用优惠券、积分及使用规则、金额明细等 |\n| `CartPromotionItem` | 购物车中商品的促销信息，含商品ID、价格、数量、促销信息、真实库存等 |\n| `OmsOrder` | 订单主表实体，含订单号、用户、金额、支付、发货、收货、状态等多维信息 |\n| `OmsOrderItem` | 订单商品项实体，含商品信息、SKU、价格、数量、分摊优惠、赠送积分/成长值等 |\n| `OmsOrderDetail` | 订单详情扩展，继承OmsOrder并补充订单项列表 |\n| `SmsCouponHistoryDetail` | 会员优惠券历史详情，含优惠券本身及关联商品/分类等 |\n| `UmsIntegrationConsumeSetting` | 积分消费规则（是否与优惠券叠加、最小使用单位、最大可抵用比例等） |"],
                        "source_id":["566"]
                    },
                    {
                        "type": "section",
                        "id": "6.4.1 ",
                        "title": "订单金额计算相关（ConfirmOrderResult.CalcAmount）",
                        "content": [
                            {
                                "type": "text",
                                "meta": "markdown",
                                "content": ["| 字段 | 类型 | 含义 |\n|------------------|------------|----------------------------------|\n| `totalAmount` | BigDecimal | 商品总金额 |\n| `freightAmount` | BigDecimal | 运费金额 |\n| `promotionAmount` | BigDecimal | 促销优惠金额 |\n| `payAmount` | BigDecimal | 应付金额（总金额-促销） |"],
                                "source_id":["566"]
                            }
                        ]
                    },
                    {
                        "type": "section",
                        "id": "6.4.2 ",
                        "title": "业务流程关键说明",
                        "content": [
                            {
                                "type": "text",
                                "meta": "markdown",
                                "content": ["| 步骤 | 说明 |\n|------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|\n| 订单确认 | 读取购物车促销信息、收货地址、可用优惠券、积分及规则，计算金额供页面展示 |\n| 订单生成 | 校验收货地址与库存，分摊优惠券及积分金额，锁定库存，生成唯一订单号，落库，更新优惠券和积分，删除购物车项，发送延迟取消消息 |\n| 支付回调 | 校验订单状态->更新为已支付->实际扣减库存 |\n| 超时/手动取消 | 查询超时/指定订单，批量/单个释放库存、恢复优惠券和积分、更新订单状态 |\n| 确认收货 | 校验用户和订单状态，更新为已收货 |\n| 订单查询/详情/删除 | 通过会员ID和状态分页查订单及明细，详情包含全部商品项；逻辑删除仅允许对已完成或已关闭订单 |"],
                                "source_id":["566"]
                            }
                        ]
                    }
                ]
            },
            {
                "type": "section",
                "id": "6.5 ",
                "title": "扩展与复用建议",
                "content": [
                    {
                        "type": "text",
                        "meta": "markdown",
                        "content": ["1. **订单状态、支付方式等建议抽象为枚举型常量，统一管理，便于扩展和可读性提升。**\n2. **订单金额计算、优惠分摊、库存操作等建议拆分为独立领域服务，便于多场景复用与单元测试。**\n3. **延迟消息机制可根据实际MQ类型抽象接口适配，支持多种消息队列方案。**\n4. **金额、库存等敏感操作建议增加事务与幂等控制，防止并发异常。**\n5. **接口参数及内部数据结构建议定义DTO/VO类，便于后续多端适配和API扩展。**"],
                        "source_id":["566"]
                    }
                ]
            },
            {
                "type": "section",
                "id": "6.6 ",
                "title": "主要数据结构（类型表）",
                "content": [
                    {
                        "type": "text",
                        "meta": "markdown",
                        "content": ["| 类型名 | 说明 |\n|------------------------------|---------------------------------------------------------------------------------------------|\n| `OmsPortalOrderServiceImpl` | 订单业务主实现类 |\n| `OmsPortalOrderService` | 订单业务接口定义 |\n| `OrderParam` | 用户提交订单参数 |\n| `ConfirmOrderResult` | 订单确认页面数据结构 |\n| `CartPromotionItem` | 购物车促销信息项 |\n| `OmsOrder` | 订单主表实体类 |\n| `OmsOrderItem` | 订单商品明细项 |\n| `OmsOrderDetail` | 订单详情，含商品明细 |\n| `SmsCouponHistoryDetail` | 优惠券历史详情（包括关联商品、分类等） |\n| `UmsIntegrationConsumeSetting` | 积分消费规则设置 |\n| `CommonPage<T>` | 通用分页响应结构 |"],
                        "source_id":["566"]
                    }
                ]
            }
        ]
    }
]